// === Serve the HTML UI ===
function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle('Customer Job Entry Form')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// === SUBMIT NEW ENTRY ===
function submitFormData(formData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const main = ss.getSheetByName('Customer Data and Job Sheet');
    const work = ss.getSheetByName('Work Committed');
    if (!main || !work) throw new Error("Sheets missing!");

    // Find next Job ID
    const lastRow = main.getLastRow();
    const nextId = lastRow > 1 ? Number(main.getRange(lastRow, 1).getValue()) + 1 : 1;

    // Write main customer/job row (now with carBoard in column 6)
    main.appendRow([
      nextId,
      formData.customerName,
      formData.phone,
      formData.carNumber,
      formData.carModel,
      formData.carBoard || 'Own', // NEW FIELD (default to 'Own')
      formData.place,
      formData.source,
      formData.date,
      formData.amountBilled,
      formData.modeOfPayment,
      formData.paidTo
    ]);

    // Write all work rows (unchanged)
    (formData.workRows || []).forEach(item => {
      work.appendRow([
        nextId,
        item.workType   || '',
        item.detail     || '',
        item.sparePart  || '',
        item.rate       || '',
        item.vendor     || '',
        formData.date   || ''
      ]);
    });

    return { success: true, message: `Job ${nextId} submitted`, jobId: nextId };
  } catch (e) {
    return { success: false, message: e.message };
  }
}

// === UPDATE EXISTING ENTRY ===
function updateFormData(formData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const main = ss.getSheetByName('Customer Data and Job Sheet');
    const work = ss.getSheetByName('Work Committed');
    if (!main || !work) throw new Error("Sheets missing!");
    const jobId = Number(formData.jobId);

    // Update main row (now 11 columns)
    const data = main.getDataRange().getValues();
    let rowToUpdate = null;
    for (let i = 1; i < data.length; i++) {
      if (Number(data[i][0]) === jobId) { rowToUpdate = i + 1; break; }
    }
    if (!rowToUpdate) throw new Error("Job ID not found");

    main.getRange(rowToUpdate, 2, 1, 11).setValues([[
      formData.customerName,
      formData.phone,
      formData.carNumber,
      formData.carModel,
      formData.carBoard || 'Own', // NEW FIELD
      formData.place,
      formData.source,
      formData.date,
      formData.amountBilled,
      formData.modeOfPayment,
      formData.paidTo
    ]]);

    // Work Committed operations (unchanged)
    const allWork = work.getDataRange().getValues();
    const header = allWork.shift();
    const keep = allWork.filter(r => Number(r[0]) !== jobId);
    work.clearContents();
    work.appendRow(header);
    keep.forEach(r => work.appendRow(r));

    (formData.workRows || []).forEach(item => {
      work.appendRow([
        jobId,
        item.workType   || '',
        item.detail     || '',
        item.sparePart  || '',
        item.rate       || '',
        item.vendor     || '',
        formData.date   || ''
      ]);
    });

    return { success: true, message: `Job ${jobId} updated` };
  } catch (e) {
    return { success: false, message: e.message };
  }
}

// === FETCH ENTRY ===
function fetchCustomerData(searchCriteria) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const main = ss.getSheetByName('Customer Data and Job Sheet');
  const work = ss.getSheetByName('Work Committed');
  const timezone = Session.getScriptTimeZone();

  if (!main || !work) throw new Error("Required sheets not found");

  // Normalize search inputs
  const normCarNum = (searchCriteria.carNumber || '').replace(/\s+/g, '').toUpperCase();
  const normPhone = (searchCriteria.phone || '').replace(/\D/g, '');
  const normName = (searchCriteria.customerName || '').trim().toUpperCase();

  // Find matching record
  const mainData = main.getDataRange().getValues().slice(1);
  const foundRecord = mainData.find(row => {
    const rowCarNum = String(row[3] || '').replace(/\s+/g, '').toUpperCase();
    const rowPhone = String(row[2] || '').replace(/\D/g, '');
    const rowName = String(row[1] || '').trim().toUpperCase();
    
    return (
      (normCarNum && rowCarNum.includes(normCarNum)) ||
      (normPhone && rowPhone === normPhone) ||
      (normName && rowName.includes(normName))
    );
  });

  if (!foundRecord) return null;

  const jobId = foundRecord[0];

  // Get all work rows
  const workData = work.getDataRange().getValues().slice(1);
  const workRows = workData
    .filter(row => Number(row[0]) === jobId)
    .map(row => ({
      workType: row[1],
      detail: row[2],
      sparePart: row[3],
      rate: row[4],
      vendor: row[5],
      date: row[6] ? Utilities.formatDate(new Date(row[6]), timezone, "yyyy-MM-dd") : ''
    }));

  return {
    jobId: jobId,
    customerName: foundRecord[1],
    phone: foundRecord[2],
    carNumber: foundRecord[3],
    carModel: foundRecord[4],
    carBoard: foundRecord[5] || 'Own', // NEW FIELD
    place: foundRecord[6], // Now column 7 (was 5)
    source: foundRecord[7],
    date: foundRecord[8] ? Utilities.formatDate(new Date(foundRecord[8]), timezone, "yyyy-MM-dd") : '',
    amountBilled: foundRecord[9],
    modeOfPayment: foundRecord[10],
    paidTo: foundRecord[11],
    workRows: workRows
  };
}

function migrateWorkCommittedToJSON() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var committedSheet = ss.getSheetByName('Work Committed');
  var outputSheet = ss.getSheetByName('Job Estimates JSON');

  var data = committedSheet.getDataRange().getValues();
  var headers = data[0];
  var jobIdIdx = headers.indexOf('Job ID');
  var groups = {};

  // Group rows by Job ID
  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    var jobId = row[jobIdIdx];
    if (!groups[jobId]) groups[jobId] = [];
    groups[jobId].push(row);
  }

  // Prepare output: [Job ID, JSON string]
  var out = [['Job ID', 'Line Items (JSON)']];
  for (var jobId in groups) {
    var items = groups[jobId].map(r => {
      var obj = {};
      headers.forEach((h, idx) => obj[h] = r[idx]);
      return obj;
    });
    out.push([jobId, JSON.stringify(items)]);
  }

  // Write to new sheet
  outputSheet.clear();
  outputSheet.getRange(1, 1, out.length, out[0].length).setValues(out);
}
